apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: monitoring
  namespace: {{ .Release.Namespace }}
  labels:
    sharding.fluxcd.io/key: tenants
    internal.cozystack.io/tenantmodule: "true"
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    apps.cozystack.io/application.kind: Monitoring
    apps.cozystack.io/application.group: apps.cozystack.io
    apps.cozystack.io/application.name: monitoring
spec:
  dependsOn:
    - name: cozystack.cozystack-controller
      namespace: cozy-system
    - name: cozystack.vertical-pod-autoscaler
      namespace: cozy-system
  chartRef:
    kind: ExternalArtifact
    name: cozystack-monitoring-application-default-monitoring
    namespace: cozy-system
  interval: 5m
  timeout: 10m
  install:
    remediation:
      retries: -1
  upgrade:
    force: true
    remediation:
      retries: -1
  values:
    enabled: true
    namespace: cozy-monitoring
    host: ""
    metricsStorages:
    - name: shortterm
      retentionPeriod: "3d"
      deduplicationInterval: "15s"
      storage: 10Gi
      storageClassName: ""
    - name: longterm
      retentionPeriod: "14d"
      deduplicationInterval: "5m"
      storage: 10Gi
      storageClassName: ""
    logsStorages:
    - name: generic
      retentionPeriod: "1"
      storage: 10Gi
      storageClassName: replicated
    alerta:
      storage: 10Gi
      storageClassName: ""
      resources:
        limits:
          cpu: "1"
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 256Mi
      alerts:
        telegram:
          token: ""
          chatID: ""
          disabledSeverity: []
        slack:
          url: ""
          disabledSeverity: []
    grafana:
      db:
        size: 10Gi
      resources:
        limits:
          cpu: "1"
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 256Mi
    vmagent:
      externalLabels:
        cluster: cozystack
      remoteWrite:
        urls:
          - http://vminsert-shortterm:8480/insert/0/prometheus
          - http://vminsert-longterm:8480/insert/0/prometheus
  valuesFrom:
  - kind: Secret
    name: cozystack-values