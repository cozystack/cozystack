{{- $ingress := .Values._namespace.ingress }}
{{- $host := .Values._namespace.host }}
{{- $harborHost := .Values.host | default (printf "harbor.%s" $host) }}

{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-credentials" .Release.Name) }}
{{- $adminPassword := randAlphaNum 16 }}
{{- if $existingSecret }}
  {{- $adminPassword = index $existingSecret.data "admin-password" | b64dec }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-credentials
stringData:
  admin-password: {{ $adminPassword | quote }}
  url: https://{{ $harborHost }}

---

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: {{ .Release.Name }}-system
  labels:
    sharding.fluxcd.io/key: tenants
spec:
  chartRef:
    kind: ExternalArtifact
    name: cozystack-harbor-application-default-harbor-system
    namespace: cozy-system
  interval: 5m
  timeout: 15m
  install:
    remediation:
      retries: -1
  upgrade:
    force: true
    remediation:
      retries: -1
  valuesFrom:
  - kind: Secret
    name: cozystack-values
  values:
    harbor:
      fullnameOverride: {{ .Release.Name }}
      harborAdminPassword: {{ $adminPassword | quote }}
      externalURL: https://{{ $harborHost }}
      expose:
        type: clusterIP
        clusterIP:
          name: {{ .Release.Name }}
        tls:
          enabled: false
      persistence:
        enabled: true
        resourcePolicy: "keep"
        persistentVolumeClaim:
          registry:
            size: {{ .Values.registry.size }}
            {{- with .Values.storageClass }}
            storageClass: {{ . }}
            {{- end }}
          database:
            size: {{ .Values.database.size }}
            {{- with .Values.storageClass }}
            storageClass: {{ . }}
            {{- end }}
          redis:
            size: {{ .Values.redis.size }}
            {{- with .Values.storageClass }}
            storageClass: {{ . }}
            {{- end }}
          {{- if .Values.trivy.enabled }}
          trivy:
            size: {{ .Values.trivy.size }}
            {{- with .Values.storageClass }}
            storageClass: {{ . }}
            {{- end }}
          {{- end }}
      portal:
        resources: {{- include "cozy-lib.resources.defaultingSanitize" (list "nano" (dict) $) | nindent 10 }}
      core:
        resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.core.resourcesPreset .Values.core.resources $) | nindent 10 }}
      registry:
        resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.registry.resourcesPreset .Values.registry.resources $) | nindent 10 }}
      jobservice:
        resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.jobservice.resourcesPreset .Values.jobservice.resources $) | nindent 10 }}
      trivy:
        enabled: {{ .Values.trivy.enabled }}
        {{- if .Values.trivy.enabled }}
        resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.trivy.resourcesPreset .Values.trivy.resources $) | nindent 10 }}
        {{- end }}
      database:
        type: internal
        internal:
          resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.database.resourcesPreset .Values.database.resources $) | nindent 12 }}
      redis:
        type: internal
        internal:
          resources: {{- include "cozy-lib.resources.defaultingSanitize" (list .Values.redis.resourcesPreset .Values.redis.resources $) | nindent 12 }}
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

---

apiVersion: cozystack.io/v1alpha1
kind: WorkloadMonitor
metadata:
  name: {{ $.Release.Name }}-core
spec:
  replicas: 1
  minReplicas: 1
  kind: harbor
  type: core
  selector:
    release: {{ $.Release.Name }}-system
    component: core
  version: {{ $.Chart.Version }}

---

apiVersion: cozystack.io/v1alpha1
kind: WorkloadMonitor
metadata:
  name: {{ $.Release.Name }}-registry
spec:
  replicas: 1
  minReplicas: 1
  kind: harbor
  type: registry
  selector:
    release: {{ $.Release.Name }}-system
    component: registry
  version: {{ $.Chart.Version }}

---

apiVersion: cozystack.io/v1alpha1
kind: WorkloadMonitor
metadata:
  name: {{ $.Release.Name }}-portal
spec:
  replicas: 1
  minReplicas: 1
  kind: harbor
  type: portal
  selector:
    release: {{ $.Release.Name }}-system
    component: portal
  version: {{ $.Chart.Version }}
