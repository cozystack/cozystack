---
apiVersion: cozystack.io/v1alpha1
kind: PackageSetDefinition
metadata:
  name: cozystack.clickhouse-operator
spec:
  sourceRef:
    kind: OCIRepository
    name: cozystack-packages
    namespace: cozy-system
    path: /
  dependsOn:
  - cozystack.networking
  - cozystack.monitoring
  - cozystack.cozystack-core
  packages:
    default:
      - name: clickhouse-operator
        path: system/clickhouse-operator
        releaseName: clickhouse-operator
        namespace: cozy-clickhouse-operator
---
apiVersion: cozystack.io/v1alpha1
kind: PackageSetDefinition
metadata:
  name: cozystack.clickhouse-application
spec:
  sourceRef:
    kind: OCIRepository
    name: cozystack-packages
    namespace: cozy-system
    path: /
  dependsOn:
  - cozystack.clickhouse-operator
  packages:
    default:
      - name: clickhouse-application
        path: system/clickhouse-application
        releaseName: clickhouse-application
        namespace: cozy-system
  applications:
    default:
      - name: clickhouse-application
        path: apps/clickhouse
        libraries:
        - path: library/cozy-lib
---
apiVersion: cozystack.io/v1alpha1
kind: PackageSetDefinition
metadata:
  name: cozystack.networking
spec:
  dependsOn:
  - cozystack.cert-manager
  packages:
    noop: []
    cilium:
      - name: cilium
        releaseName: cilium
        path: system/cilium
        namespace: cozy-cilium
        privileged: true
        dependsOn: []
        valuesFiles:
        - values.yaml
        - values-talos.yaml
      - name: cilium-networkpolicy
        releaseName: cilium-networkpolicy
        path: system/cilium-networkpolicy
        namespace: cozy-cilium
        privileged: true
        dependsOn: [cilium]
    kubeovn-cilium:
      - name: cilium
        releaseName: cilium
        path: system/cilium
        namespace: cozy-cilium
        privileged: true
        dependsOn: []
        valuesFiles:
        - values.yaml
        - values-talos.yaml
        - values-kubeovn.yaml
      - name: cilium-networkpolicy
        releaseName: cilium-networkpolicy
        path: system/cilium-networkpolicy
        namespace: cozy-cilium
        privileged: true
        dependsOn: [cilium]
      - name: kubeovn
        releaseName: kubeovn
        path: system/kubeovn
        namespace: cozy-kubeovn
        privileged: true
        dependsOn: [cilium]
      - name: kubeovn-plunger
        releaseName: kubeovn-plunger
        path: system/kubeovn-plunger
        namespace: cozy-kubeovn
        dependsOn: [cilium,kubeovn]
      - name: kubeovn-webhook
        releaseName: kubeovn-webhook
        path: system/kubeovn-webhook
        namespace: cozy-kubeovn
        privileged: true
        dependsOn: [cilium,kubeovn]

# PackageSetDefinition --> ArtifactGenerator --> ExternalArtifact (many)
# PackageSet --> HelmRelease (many)
---
apiVersion: cozystack.io/v1alpha1
kind: PackageSet
metadata:
  name: cozystack.networking
spec:
  #ignoreDependencies:
  #- cozystack.networking
  packages:
    cilium:
      enabled: false
      values:
        kubeProxyReplacement: strict
        k8sServiceHost: api.example.org
        k8sServicePort: 6443
    kubeovn:
      values:
        kube-ovn:
          ipv4:
            POD_CIDR: "10.244.0.0/16"
            POD_GATEWAY: "10.244.0.1"
            SVC_CIDR: "10.96.0.0/16"
            JOIN_CIDR: "100.64.0.0/16"

---
apiVersion: cozystack.io/v1alpha1
kind: PackageSetDefinition
metadata:
  name: cozystack.cozystack-core
spec:
  packages:
    default:
      - name: cozystack-controller
        releaseName: cozystack-controller
        path: system/cozystack-controller
        namespace: cozy-system
        dependsOn: []
      - name: cozystack-api
        releaseName: cozystack-api
        path: system/cozystack-api
        namespace: cozy-system
        dependsOn: [cozystack-controller]
      - name: lineage-controller-webhook
        releaseName: lineage-controller-webhook
        path: system/lineage-controller-webhook
        namespace: cozy-system
        dependsOn: [cozystack-controller]
      - name: dashboard
        releaseName: dashboard
        path: system/dashboard
        namespace: cozy-dashboard
        dependsOn: [cozystack-api,cozystack-controller]
    oidc:
      - name: cozystack-controller
        releaseName: cozystack-controller
        path: system/cozystack-controller
        namespace: cozy-system
        dependsOn: []
      - name: cozystack-api
        releaseName: cozystack-api
        path: system/cozystack-api
        namespace: cozy-system
        dependsOn: [cozystack-controller]
      - name: lineage-controller-webhook
        releaseName: lineage-controller-webhook
        path: system/lineage-controller-webhook
        namespace: cozy-system
        dependsOn: [cozystack-controller]
      - name: dashboard
        releaseName: dashboard
        path: system/dashboard
        namespace: cozy-dashboard
        dependsOn: [cozystack-api,cozystack-controller,keycloak-configure]
      - name: keycloak-configure
        releaseName: keycloak-configure
        path: system/keycloak-configure
        namespace: cozy-keycloak
        dependsOn: [keycloak-operator]
      - name: keycloak
        releaseName: keycloak
        path: system/keycloak
        namespace: cozy-keycloak
        dependsOn: [postgres-operator]
        libraries:
        - path: library/cozy-lib
      - name: keycloak-operator
        releaseName: keycloak-operator
        path: system/keycloak-operator
        namespace: cozy-keycloak
        dependsOn: [keycloak]
