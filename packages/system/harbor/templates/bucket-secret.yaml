{{- if .Values.bucket.secretName }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace .Values.bucket.secretName }}
{{- $bucketInfo := fromJson (b64dec (index $existingSecret.data "BucketInfo")) }}
{{- $accessKeyID := index $bucketInfo.spec.secretS3 "accessKeyID" }}
{{- $accessSecretKey := index $bucketInfo.spec.secretS3 "accessSecretKey" }}
{{- $endpoint := index $bucketInfo.spec.secretS3 "endpoint" }}
{{- $bucketName := $bucketInfo.spec.bucketName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.harbor.fullnameOverride }}-registry-s3
type: Opaque
stringData:
  REGISTRY_STORAGE_S3_ACCESSKEY: {{ $accessKeyID | quote }}
  REGISTRY_STORAGE_S3_SECRETKEY: {{ $accessSecretKey | quote }}
  REGISTRY_STORAGE_S3_REGIONENDPOINT: {{ $endpoint | quote }}
  REGISTRY_STORAGE_S3_BUCKET: {{ $bucketName | quote }}
  REGISTRY_STORAGE_S3_REGION: "us-east-1"
{{- end }}
