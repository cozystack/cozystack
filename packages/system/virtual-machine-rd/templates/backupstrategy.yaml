{{- if .Capabilities.APIVersions.Has "strategy.backups.cozystack.io/v1alpha1" }}
apiVersion: strategy.backups.cozystack.io/v1alpha1
kind: Velero
metadata:
  name: velero-backup-strategy-for-virtualmachines
spec:
  template:
    spec:
      csiSnapshotTimeout: 10m0s
      includedNamespaces:
      - '{{ printf "{{ .Application.metadata.namespace }}" }}'
      orLabelSelector:
      - matchLabels:
          apps.cozystack.io/application.group: apps.cozystack.io
          apps.cozystack.io/application.kind: '{{ printf "{{ .Application.kind }}" }}'
          apps.cozystack.io/application.name: '{{ printf "{{ .Application.metadata.name }}"}}'
      - matchLabels:
          app.kubernetes.io/instance: 'virtual-machine-{{ printf "{{ .Application.metadata.name }}"}}' 
      includedResources:
        - helmreleases.helm.toolkit.fluxcd.io
        - virtualmachines.kubevirt.io
        - virtualmachineinstances.kubevirt.io
        - datavolumes.cdi.kubevirt.io
        - persistentvolumeclaims
        - services
        - configmaps
        - secrets
      storageLocation: '{{ printf "{{ .Parameters.backupStorageLocationName }}" }}'
      volumeSnapshotLocations:
        - '{{ printf "{{ .Parameters.backupStorageLocationName }}" }}'
      snapshotVolumes: true
      snapshotMoveData: true
      ttl: 720h0m0s
      itemOperationTimeout: 24h0m0s
{{- end }}
