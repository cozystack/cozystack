suite: Extra StorageClasses tests

templates:
  - templates/extra-storageclasses.yaml

tests:
  - it: renders nothing when extraStorageClasses is empty
    asserts:
      - hasDocuments:
          count: 0

  - it: creates one StorageClass per entry
    set:
      extraStorageClasses:
        nfs-data:
          server: "10.96.1.1"
          share: "/"
          port: "2049"
        nfs-backup:
          server: "10.96.2.2"
          share: "/"
          port: "2050"
    asserts:
      - hasDocuments:
          count: 2

  - it: sets correct provisioner
    set:
      extraStorageClasses:
        nfs-test:
          server: "10.96.1.1"
          share: "/"
          port: "2049"
    asserts:
      - equal:
          path: provisioner
          value: nfs.csi.k8s.io

  - it: sets server and share parameters
    set:
      extraStorageClasses:
        nfs-mydata:
          server: "10.96.50.100"
          share: "/exports"
          port: "2049"
    asserts:
      - equal:
          path: metadata.name
          value: nfs-mydata
      - equal:
          path: parameters.server
          value: "10.96.50.100"
      - equal:
          path: parameters.share
          value: "/exports"

  - it: sets mount options with port
    set:
      extraStorageClasses:
        nfs-test:
          server: "10.96.1.1"
          share: "/"
          port: "2049"
    asserts:
      - equal:
          path: mountOptions[0]
          value: nfsvers=4.2
      - equal:
          path: mountOptions[1]
          value: port=2049

  - it: allows volume expansion
    set:
      extraStorageClasses:
        nfs-test:
          server: "10.96.1.1"
          share: "/"
          port: "2049"
    asserts:
      - equal:
          path: allowVolumeExpansion
          value: true

  - it: uses Delete reclaim policy
    set:
      extraStorageClasses:
        nfs-test:
          server: "10.96.1.1"
          share: "/"
          port: "2049"
    asserts:
      - equal:
          path: reclaimPolicy
          value: Delete

  - it: creates distinct StorageClasses for multiple shares
    set:
      extraStorageClasses:
        nfs-alpha:
          server: "10.96.10.1"
          share: "/"
          port: "2049"
        nfs-beta:
          server: "10.96.20.2"
          share: "/data"
          port: "2050"
    asserts:
      - equal:
          path: metadata.name
          value: nfs-alpha
        documentIndex: 0
      - equal:
          path: parameters.server
          value: "10.96.10.1"
        documentIndex: 0
      - equal:
          path: metadata.name
          value: nfs-beta
        documentIndex: 1
      - equal:
          path: parameters.server
          value: "10.96.20.2"
        documentIndex: 1
      - equal:
          path: parameters.share
          value: "/data"
        documentIndex: 1
