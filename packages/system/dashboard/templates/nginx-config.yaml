apiVersion: v1
data:
  nginx-config: |-
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
      listen       8080 default_server;
      listen       [::]:8080 default_server;
      server_name  _;

      location ~ ^(/clusterlist|/api/clusters)$ {
        add_header Content-Type application/json;
        set $cluster_list '[{"api":"incloud-api.dev5.infra.aenix.org","baseDomain":"dev5.infra.aenix.org","description":"dashboard.dev5.infra.aenix.org","externalDomain":"dashboard.dev5.infra.aenix.org","name":"cozydev4","tenant":"dev"}]';
        return 200 $cluster_list;
      }

      location /api/clusters/cozydev4 {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Host $host;
          proxy_read_timeout 86400s;
          proxy_send_timeout 86400s;

          rewrite /api/clusters/cozydev4/(.*) /$1  break;
          proxy_pass http://incloud-web-nginx.incloud-web.svc:8080;
      }

      location /k8s {
          rewrite /k8s/(.*) /$1  break;
          proxy_pass https://kubernetes.default.svc:443;
      }

      location /openapi-bff {
          proxy_pass http://incloud-web-web.incloud-web.svc:64231;
      }


      location /openapi-bff-ws/ {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Host $host;
          proxy_read_timeout 86400s;
          proxy_send_timeout 86400s;

          proxy_pass http://incloud-web-web.incloud-web.svc:64231;
      }

      location = / {
          return 301 https://dashboard.dev5.infra.aenix.org/openapi-ui;
      }

      location / {
          proxy_pass http://incloud-web-web.incloud-web.svc:8080;
      }

      location /healthcheck {
          access_log off;
          return 200 "Healthy\n";
      }
    }
kind: ConfigMap
metadata:
  annotations: {}
  labels:
    app.kubernetes.io/instance: incloud-web
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: nginx
    app.kubernetes.io/version: 1.16.0
    helm.sh/chart: appSpec-0.1.0
  name: incloud-web-nginx-config
  namespace: incloud-web
