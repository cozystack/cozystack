worker_processes 1;
daemon off;
error_log /dev/stderr warn;

events {
    worker_connections 4096;
}

http {
    access_log /dev/stderr;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 8080 default_server;

        # Static cluster list
        location ~ ^(/clusterlist|/api/clusters)$ {
            add_header Content-Type application/json;
            return 200 '[{"api":"localhost","baseDomain":"localhost","description":"local","externalDomain":"localhost","name":"default","tenant":"dev"}]';
        }

        # Strip /api/clusters/default prefix and self-proxy (same as production)
        location /api/clusters/default {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;

            rewrite /api/clusters/default/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8080;
        }

        # K8s API via kubectl proxy
        location /k8s {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_buffering off;

            rewrite /k8s/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8081;
        }

        # BFF HTTP
        location /openapi-bff {
            proxy_pass http://127.0.0.1:4002;
        }

        # BFF WebSocket
        location /openapi-bff-ws/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;

            proxy_pass http://127.0.0.1:4002;
        }

        # Redirect / to /openapi-ui
        location = / {
            return 301 /openapi-ui;
        }

        # Frontend (Vite dev server) â€” catch-all with WebSocket support for HMR
        location / {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;

            proxy_pass http://127.0.0.1:4001;
        }

        location /healthcheck {
            access_log off;
            return 200 "Healthy\n";
        }
    }
}
