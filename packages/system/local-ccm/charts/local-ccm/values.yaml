# Default values for local-ccm

image:
  repository: ghcr.io/cozystack/local-ccm
  tag: v0.3.0
  pullPolicy: Always
# Service account configuration
serviceAccount:
  create: true
  name: local-ccm
# IP detection configuration
ipDetection:
  # Target IP for external IP detection via 'ip route get'
  externalIPTarget: "8.8.8.8"
  # Target IP for internal IP detection via 'ip route get'
  # If empty, internal IP detection is disabled and kubelet's InternalIP is preserved
  internalIPTarget: ""
# Controller configuration
controller:
  # Remove node.cloudprovider.kubernetes.io/uninitialized taint
  removeTaint: true
  # Interval between reconciliation loops
  reconcileInterval: 10s
  # Verbosity level (0-5)
  verbosity: 2
# Pod resources
resources:
  requests:
    cpu: 10m
    memory: 32Mi
  limits:
    cpu: 100m
    memory: 64Mi
# Security context for the container
securityContext:
  capabilities:
    add:
      - NET_ADMIN # Required for netlink route queries
      - NET_RAW
  runAsUser: 0 # Must run as root to access netlink
# Tolerations - by default tolerate all taints to run on every node
tolerations:
  - operator: Exists
# Node affinity configuration
affinity:
  nodeAffinity:
    # Prefer to schedule on nodes needing initialization first
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: node.cloudprovider.kubernetes.io/uninitialized
              operator: Exists
# Additional labels for all resources
labels: {}
# Additional annotations for pods
podAnnotations: {}
# Node Lifecycle Controller - deletes unreachable NotReady nodes
nodeLifecycleController:
  # Enable node lifecycle controller
  enabled: true
  image:
    repository: ghcr.io/cozystack/local-ccm
    tag: "v0.3.0" # Defaults to appVersion
    pullPolicy: IfNotPresent
  # Controller configuration
  controller:
    # Watch only nodes with ToBeDeletedByClusterAutoscaler taint
    # Ignored when nodeSelector is set
    watchAutoscalerTaint: true
    # Label selector for nodes to manage
    # Only nodes matching this selector will be considered for deletion
    # Example: "node.kubernetes.io/instance-type" (nodes created by autoscaler)
    nodeSelector: ""
    # Comma-separated list of labels/annotations that protect nodes from deletion
    # Nodes with any of these labels will never be deleted
    # Example: "kilo.squat.ai/leader,cluster-autoscaler.kubernetes.io/scale-down-disabled"
    protectedLabels: ""
    # Duration a node must be NotReady before considering deletion
    notReadyTimeout: 5m
    # Timeout for ping checks
    pingTimeout: 5s
    # Number of ping attempts before considering node unreachable
    pingCount: 3
    # Interval between reconciliation loops
    reconcileInterval: 30s
    # Log actions without actually deleting nodes
    dryRun: false
    # Verbosity level (0-5)
    verbosity: 2
  # Leader election for HA
  leaderElection:
    enabled: true
    resourceName: node-lifecycle-controller
  # Number of replicas (only 1 will be active due to leader election)
  replicaCount: 1
  # Service account configuration
  serviceAccount:
    create: true
    annotations: {}
  # Pod resources
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi
  # Security context for the pod
  podSecurityContext:
    runAsNonRoot: false # Need root for ICMP ping
  # Security context for the container
  securityContext:
    capabilities:
      add:
        - NET_RAW # Required for ICMP ping
    runAsUser: 0 # Must run as root for raw sockets
  # Node selector for the controller pod
  nodeSelector: {}
  # Tolerations for the controller pod
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
  # Affinity for the controller pod
  affinity:
    nodeAffinity:
      # Prefer to run on control-plane nodes
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
  # Additional annotations for pods
  podAnnotations: {}
  # Use host network for ping to work across network boundaries
  hostNetwork: true
