---
apiVersion: v1
kind: Namespace
metadata:
  name: tenant-root
---
{{- $existingValues := dict }}
{{- $existing := lookup "helm.toolkit.fluxcd.io/v2" "HelmRelease" "tenant-root" "tenant-root" }}
{{- if and $existing $existing.spec $existing.spec.values }}
{{- $existingValues = omit $existing.spec.values "_cluster" }}
{{- end }}
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    helm.sh/resource-policy: keep
  labels:
    sharding.fluxcd.io/key: tenants
    apps.cozystack.io/application.kind: Tenant
    apps.cozystack.io/application.group: apps.cozystack.io
    apps.cozystack.io/application.name: tenant-root
  name: tenant-root
  namespace: tenant-root
spec:
  chartRef:
    kind: ExternalArtifact
    name: cozystack-tenant-application-default-tenant
    namespace: cozy-system
  interval: 1m0s
  timeout: 5m0s
  values:
    {{- $clusterValues := dict
        "oidc-enabled" (.Values.oidcEnabled | toString)
        "root-host" (.Values.rootHost | toString)
    }}
    {{- $mergedValues := merge (dict "_cluster" $clusterValues) $existingValues }}
    {{- $mergedValues | toYaml | nindent 4 }}
