## Release.Namespace == tenant name
## Release.Name == vpc name

{{ $vpcId := print "vpc-" (print .Release.Namespace "/" .Release.Name | sha256sum | trunc 6) }}

---
apiVersion: kubeovn.io/v1
kind: Vpc
metadata:
  name: {{ $vpcId }}
  labels:
    cozystack.io/vpcName: {{ .Release.Name }}
    cozystack.io/tenantName: {{ .Release.Namespace }}
spec:
  enableExternal: false
  namespaces:
    - {{ .Release.Namespace }}

{{- range $subnetName, $subnetConfig := .Values.subnets  }}
{{- $subnetId := print "subnet-" (print $.Release.Namespace "/" $vpcId "/" $subnetName | sha256sum | trunc 8) }}
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: {{ $subnetId }}
  namespace: {{ $.Release.Namespace }}
  labels:
    cozystack.io/subnetName: {{ $subnetName }}
    cozystack.io/vpcId: {{ $vpcId }}
    cozystack.io/vpcName: {{ $.Release.Name }}
    cozystack.io/tenantName: {{ $.Release.Namespace }}
spec:
  config: '{
      "cniVersion": "0.3.0",
      "type": "kube-ovn",
      "server_socket": "/run/openvswitch/kube-ovn-daemon.sock",
      "provider": "{{ $subnetId }}.{{ $.Release.Namespace }}.ovn"
    }'
---
apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: {{ $subnetId }}
  labels:
    cozystack.io/subnetName: {{ $subnetName }}
    cozystack.io/vpcId: {{ $vpcId }}
    cozystack.io/vpcName: {{ $.Release.Name }}
    cozystack.io/tenantName: {{ $.Release.Namespace }}
spec:
  vpc: {{ $vpcId  }}
  cidrBlock: {{ $subnetConfig.cidr }}
  provider: "{{ $subnetId }}.{{ $.Release.Namespace }}.ovn"
  protocol: IPv4
  enableLb: false
  private: true
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $vpcId }}-subnets
  labels:
    cozystack.io/vpcName: {{ $.Release.Name }}
    cozystack.io/tenantName: {{ $.Release.Namespace }}
data:
  subnets: |
    {{- range $subnetName, $subnetConfig := .Values.subnets }}
    - subnetName: {{ $subnetName }}
      subnetId: {{ print "subnet-" (print $.Release.Namespace "/" $vpcId "/" $subnetName | sha256sum | trunc 8) }}
      subnetCIDR: {{ $subnetConfig.cidr }}
    {{- end }}

