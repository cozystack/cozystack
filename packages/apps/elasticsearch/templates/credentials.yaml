{{- $clusterDomain := (index .Values._cluster "cluster-domain") | default "cozy.local" }}
{{- $operatorSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-es-elastic-user" .Release.Name) }}
{{- $password := "" }}
{{- if and $operatorSecret (hasKey $operatorSecret.data "elastic") }}
{{- $password = index $operatorSecret.data "elastic" | b64dec }}
{{- end }}
---
# Dashboard credentials - lookup from operator-created secret
# ECK creates secret named "<release>-es-elastic-user" with the elastic superuser password
# Note: On first install, password/uri will be empty until operator creates the secret.
# Run 'helm upgrade' after Elasticsearch is ready to populate credentials.
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-credentials
type: Opaque
stringData:
  username: elastic
  password: {{ $password | quote }}
  host: {{ .Release.Name }}-es-http.{{ .Release.Namespace }}.svc.{{ $clusterDomain }}
  port: "9200"
  {{- if $password }}
  uri: https://elastic:{{ $password | urlquery }}@{{ .Release.Name }}-es-http.{{ .Release.Namespace }}.svc.{{ $clusterDomain }}:9200
  {{- else }}
  uri: ""
  {{- end }}
  {{- if .Values.kibana.enabled }}
  kibana-host: {{ .Release.Name }}-kb-http.{{ .Release.Namespace }}.svc.{{ $clusterDomain }}
  kibana-port: "5601"
  {{- if $password }}
  kibana-uri: https://elastic:{{ $password | urlquery }}@{{ .Release.Name }}-kb-http.{{ .Release.Namespace }}.svc.{{ $clusterDomain }}:5601
  {{- else }}
  kibana-uri: ""
  {{- end }}
  {{- end }}
