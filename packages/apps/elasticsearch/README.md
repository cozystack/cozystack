# Managed Elasticsearch Service

Elasticsearch is a distributed search and analytics engine built on Apache Lucene.
The Managed Elasticsearch Service provides a self-healing cluster managed by the Elastic Cloud on Kubernetes (ECK) Operator.

## Deployment Details

This managed service is controlled by the ECK Operator, ensuring efficient management and seamless operation.

- Docs: <https://www.elastic.co/guide/en/cloud-on-k8s/current/index.html>
- GitHub: <https://github.com/elastic/cloud-on-k8s>

## Prerequisites

Elasticsearch requires the kernel parameter `vm.max_map_count` to be set to at least 262144. This is automatically configured by the ECK operator's DaemonSet on all cluster nodes.

No special namespace configuration is required.

## Features

- **High Availability**: Deploy multi-node clusters with automatic failover
- **Topology Spread**: Automatic distribution across nodes and availability zones
- **Kibana Integration**: Optional Kibana deployment for visualization and management
- **TLS Encryption**: Automatic TLS certificate management
- **External Access**: Optional LoadBalancer service for external connectivity
- **Custom Users**: Create additional users with specific roles

## Deployment via Cozystack API

Deploy Elasticsearch using the Cozystack CRD:

```yaml
apiVersion: cozystack.io/v1alpha1
kind: Elasticsearch
metadata:
  name: my-elasticsearch
  namespace: tenant-default
spec:
  replicas: 3
  version: v9
  size: 10Gi
  resourcesPreset: large
  kibana:
    enabled: true
    replicas: 1
    resourcesPreset: medium
```

### Minimal deployment (single node, no Kibana):

```yaml
apiVersion: cozystack.io/v1alpha1
kind: Elasticsearch
metadata:
  name: my-elasticsearch
  namespace: tenant-default
spec:
  replicas: 1
  version: v9
  size: 5Gi
```

Note: Single-replica deployments automatically use `replicated` storage class for data resilience.

### Production deployment with strict topology spread:

```yaml
apiVersion: cozystack.io/v1alpha1
kind: Elasticsearch
metadata:
  name: my-elasticsearch
  namespace: tenant-default
spec:
  replicas: 3
  version: v9
  size: 50Gi
  storageClass: replicated
  resourcesPreset: xlarge
  topologySpreadPolicy: hard
  external: true
  kibana:
    enabled: true
    replicas: 2
    resourcesPreset: large
  users:
    analyst:
      roles:
        - viewer
        - reporting_user
    ingest-service:
      roles:
        - editor
```

## Notes

### Credentials

Credentials are automatically generated by the ECK operator. Access them via:

```bash
# Get the elastic user password
kubectl get secret <release-name>-credentials -n <namespace> -o jsonpath='{.data.password}' | base64 -d

# Get the full connection URI
kubectl get secret <release-name>-credentials -n <namespace> -o jsonpath='{.data.uri}' | base64 -d
```

### Custom Users

Custom users are created as secrets with auto-generated passwords (unless specified). Get a user's password:

```bash
kubectl get secret <release-name>-user-<username> -n <namespace> -o jsonpath='{.data.password}' | base64 -d
```

Available built-in roles include: `superuser`, `kibana_admin`, `editor`, `viewer`, `reporting_user`, `ingest_admin`, `monitoring_user`.

### Resource Requirements

Elasticsearch requires significant memory. The minimum recommended preset is `large` (2Gi RAM per node).
Kibana requires minimum `medium` preset (1Gi RAM).

| Preset | CPU | Memory |
|--------|-----|--------|
| large | 2 | 2Gi |
| xlarge | 4 | 4Gi |
| 2xlarge | 8 | 8Gi |

### Topology Spread Policy

The `topologySpreadPolicy` controls how pods are distributed across nodes and zones:

- **soft** (default): Best-effort distribution. Pods may be scheduled on the same node if no other option is available.
- **hard**: Strict distribution. Pods will remain pending if they cannot be evenly distributed across nodes/zones.

Use `hard` for production environments where high availability is critical and you have sufficient nodes.

### External Access

When `external: true` is enabled, LoadBalancer services are created for:
- Elasticsearch API (port 9200)
- Kibana UI (port 5601) - if Kibana is enabled

## Parameters

### Common parameters

| Name                   | Description                                                                                                                          | Type       | Value   |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ---------- | ------- |
| `replicas`             | Number of Elasticsearch nodes in the cluster.                                                                                        | `int`      | `3`     |
| `resources`            | Explicit CPU and memory configuration for each Elasticsearch node. When omitted, the preset defined in `resourcesPreset` is applied. | `object`   | `{}`    |
| `resources.cpu`        | CPU available to each node.                                                                                                          | `quantity` | `""`    |
| `resources.memory`     | Memory (RAM) available to each node.                                                                                                 | `quantity` | `""`    |
| `resourcesPreset`      | Default sizing preset used when `resources` is omitted. Elasticsearch requires minimum 2Gi memory.                                   | `string`   | `large` |
| `size`                 | Persistent Volume Claim size available for application data.                                                                         | `quantity` | `10Gi`  |
| `storageClass`         | StorageClass used to store the data.                                                                                                 | `string`   | `""`    |
| `external`             | Enable external access from outside the cluster.                                                                                     | `bool`     | `false` |
| `topologySpreadPolicy` | How strictly to enforce pod distribution across nodes and zones.                                                                     | `string`   | `soft`  |
| `version`              | Elasticsearch major version to deploy.                                                                                               | `string`   | `v9`    |


### Image configuration

| Name                   | Description                            | Type     | Value                                                  |
| ---------------------- | -------------------------------------- | -------- | ------------------------------------------------------ |
| `images`               | Container images used by the operator. | `object` | `{}`                                                   |
| `images.elasticsearch` | Elasticsearch image.                   | `string` | `docker.elastic.co/elasticsearch/elasticsearch:8.17.0` |


### Node roles configuration

| Name               | Description                   | Type     | Value   |
| ------------------ | ----------------------------- | -------- | ------- |
| `nodeRoles`        | Node roles configuration.     | `object` | `{}`    |
| `nodeRoles.master` | Enable master role.           | `bool`   | `true`  |
| `nodeRoles.data`   | Enable data role.             | `bool`   | `true`  |
| `nodeRoles.ingest` | Enable ingest role.           | `bool`   | `true`  |
| `nodeRoles.ml`     | Enable machine learning role. | `bool`   | `false` |


### Users configuration

| Name                   | Description                                        | Type                | Value |
| ---------------------- | -------------------------------------------------- | ------------------- | ----- |
| `users`                | Custom Elasticsearch users configuration map.      | `map[string]object` | `{}`  |
| `users[name].password` | Password for the user (auto-generated if omitted). | `string`            | `""`  |
| `users[name].roles`    | List of Elasticsearch roles.                       | `[]string`          | `[]`  |


### Kibana configuration

| Name                      | Description                                       | Type       | Value    |
| ------------------------- | ------------------------------------------------- | ---------- | -------- |
| `kibana`                  | Kibana configuration.                             | `object`   | `{}`     |
| `kibana.enabled`          | Enable Kibana deployment.                         | `bool`     | `false`  |
| `kibana.replicas`         | Number of Kibana replicas.                        | `int`      | `1`      |
| `kibana.resources`        | Explicit CPU and memory configuration for Kibana. | `object`   | `{}`     |
| `kibana.resources.cpu`    | CPU available to each node.                       | `quantity` | `""`     |
| `kibana.resources.memory` | Memory (RAM) available to each node.              | `quantity` | `""`     |
| `kibana.resourcesPreset`  | Default sizing preset for Kibana.                 | `string`   | `medium` |

