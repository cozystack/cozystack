suite: user secrets tests

templates:
  - templates/user-secrets.yaml

tests:
  # No users configured
  - it: does not render when no users defined
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      users: {}
    asserts:
      - hasDocuments:
          count: 0

  # Single user
  - it: creates secret for single user
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      users:
        myuser:
          db: mydb
          roles:
            - name: readWrite
              db: mydb
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: test-mongodb-user-myuser
      - equal:
          path: type
          value: Opaque
      - exists:
          path: stringData.password

  # Multiple users
  - it: creates separate secrets for multiple users
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      users:
        user1:
          db: db1
          roles:
            - name: readWrite
              db: db1
        user2:
          db: db2
          roles:
            - name: dbAdmin
              db: db2
    asserts:
      - hasDocuments:
          count: 2

  # User with explicit password
  - it: uses explicit password when provided
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      users:
        myuser:
          password: "mysecretpassword"
          db: mydb
          roles:
            - name: readWrite
              db: mydb
    asserts:
      - equal:
          path: stringData.password
          value: "mysecretpassword"

  # Secret naming convention
  - it: follows naming convention release-user-username
    release:
      name: prod-db
      namespace: tenant-prod
    set:
      users:
        admin:
          db: admin
          roles:
            - name: clusterAdmin
              db: admin
    asserts:
      - equal:
          path: metadata.name
          value: prod-db-user-admin
