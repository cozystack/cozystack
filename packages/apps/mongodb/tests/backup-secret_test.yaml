suite: backup secret tests

templates:
  - templates/backup-secret.yaml

tests:
  # Not rendered when both backup and bootstrap disabled
  - it: does not render when backup and bootstrap disabled
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: false
      bootstrap:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # Rendered when backup enabled
  - it: renders when backup enabled
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: true
        s3AccessKey: "AKIAIOSFODNN7EXAMPLE"
        s3SecretKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret

  # Rendered when bootstrap enabled (for restore)
  - it: renders when bootstrap enabled
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: false
        s3AccessKey: "AKIAIOSFODNN7EXAMPLE"
        s3SecretKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
      bootstrap:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1

  # Secret name
  - it: uses correct secret name
    release:
      name: mydb
      namespace: tenant-test
    set:
      backup:
        enabled: true
        s3AccessKey: "accesskey"
        s3SecretKey: "secretkey"
    asserts:
      - equal:
          path: metadata.name
          value: mydb-s3-creds

  # Contains AWS credentials
  - it: contains AWS credentials
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: true
        s3AccessKey: "MYACCESSKEY"
        s3SecretKey: "MYSECRETKEY"
    asserts:
      - equal:
          path: stringData.AWS_ACCESS_KEY_ID
          value: "MYACCESSKEY"
      - equal:
          path: stringData.AWS_SECRET_ACCESS_KEY
          value: "MYSECRETKEY"

  # Fails without s3AccessKey
  - it: fails when s3AccessKey missing
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: true
        s3AccessKey: ""
        s3SecretKey: "secretkey"
    asserts:
      - failedTemplate:
          errorMessage: "backup.s3AccessKey is required when backup or bootstrap is enabled"

  # Fails without s3SecretKey
  - it: fails when s3SecretKey missing
    release:
      name: test-mongodb
      namespace: tenant-test
    set:
      backup:
        enabled: true
        s3AccessKey: "accesskey"
        s3SecretKey: ""
    asserts:
      - failedTemplate:
          errorMessage: "backup.s3SecretKey is required when backup or bootstrap is enabled"
