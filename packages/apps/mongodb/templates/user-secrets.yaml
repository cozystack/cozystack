{{- range $username, $user := .Values.users }}
{{- $existingSecret := lookup "v1" "Secret" $.Release.Namespace (printf "%s-user-%s" $.Release.Name $username) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $.Release.Name }}-user-{{ $username }}
type: Opaque
stringData:
  {{- if $user.password }}
  password: {{ $user.password | quote }}
  {{- else if and $existingSecret (hasKey $existingSecret.data "password") }}
  password: {{ index $existingSecret.data "password" | b64dec | quote }}
  {{- else }}
  password: {{ randAlphaNum 16 | quote }}
  {{- end }}
{{- end }}
