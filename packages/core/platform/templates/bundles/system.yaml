{{- if .Values.bundles.system.enabled }}

# Networking
{{- if eq .Values.bundles.system.variant "isp-full" }}
{{- $networkingComponents := dict -}}
{{- if .Values.networking -}}
{{- $kubeovnIpv4 := dict
  "POD_CIDR" .Values.networking.podCIDR
  "POD_GATEWAY" .Values.networking.podGateway
  "SVC_CIDR" .Values.networking.serviceCIDR
  "JOIN_CIDR" .Values.networking.joinCIDR -}}
{{- $kubeovnDict := dict "ipv4" $kubeovnIpv4 -}}
{{- if .Values.networking.kubeovn.MASTER_NODES -}}
{{- $_ := set $kubeovnDict "MASTER_NODES" .Values.networking.kubeovn.MASTER_NODES -}}
{{- end -}}
{{- $kubeovnValues := dict "kube-ovn" $kubeovnDict -}}
{{- $_ := set $networkingComponents "kubeovn" (dict "values" $kubeovnValues) -}}
{{- $ciliumValues := dict "cilium" (dict
  "k8sServiceHost" .Values.networking.apiServer.host
  "k8sServicePort" .Values.networking.apiServer.port
  "cgroup" (dict "autoMount" (dict "enabled" .Values.networking.cilium.cgroup.autoMount))) -}}
{{- $_ := set $networkingComponents "cilium" (dict "values" $ciliumValues) -}}
{{- end -}}
{{include "cozystack.platform.package" (list "cozystack.networking" "kubeovn-cilium" $ $networkingComponents) }}
{{include "cozystack.platform.package.default" (list "cozystack.kubeovn-webhook" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.kubeovn-plunger" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.cozy-proxy" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.multus" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.metallb" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.reloader" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.linstor" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.linstor-scheduler" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.snapshot-controller" $) }}
{{- end }}

{{- if eq .Values.bundles.system.variant "isp-hosted" }}
{{include "cozystack.platform.package" (list "cozystack.networking" "noop" $) }}
{{- end }}

{{- if eq .Values.bundles.system.variant "isp-full-generic" }}
{{- $networkingComponents := dict -}}
{{- if .Values.networking -}}
{{- $kubeovnIpv4 := dict
  "POD_CIDR" .Values.networking.podCIDR
  "POD_GATEWAY" .Values.networking.podGateway
  "SVC_CIDR" .Values.networking.serviceCIDR
  "JOIN_CIDR" .Values.networking.joinCIDR -}}
{{- $kubeovnDict := dict "ipv4" $kubeovnIpv4 -}}
{{- if .Values.networking.kubeovn.MASTER_NODES -}}
{{- $_ := set $kubeovnDict "MASTER_NODES" .Values.networking.kubeovn.MASTER_NODES -}}
{{- end -}}
{{- $kubeovnValues := dict "kube-ovn" $kubeovnDict -}}
{{- $_ := set $networkingComponents "kubeovn" (dict "values" $kubeovnValues) -}}
{{- $ciliumValues := dict "cilium" (dict
  "k8sServiceHost" .Values.networking.apiServer.host
  "k8sServicePort" .Values.networking.apiServer.port
  "cgroup" (dict "autoMount" (dict "enabled" .Values.networking.cilium.cgroup.autoMount))) -}}
{{- $_ := set $networkingComponents "cilium" (dict "values" $ciliumValues) -}}
{{- end -}}
{{- /* Use kubeovn-cilium-generic variant (no values-talos.yaml) */ -}}
{{include "cozystack.platform.package" (list "cozystack.networking" "kubeovn-cilium-generic" $ $networkingComponents) }}
{{include "cozystack.platform.package.default" (list "cozystack.kubeovn-webhook" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.kubeovn-plunger" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.cozy-proxy" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.multus" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.metallb" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.reloader" $) }}
{{- /* Pass talos.enabled: false to linstor for generic Linux */ -}}
{{- $linstorComponents := dict "linstor" (dict "values" (dict "talos" (dict "enabled" false))) -}}
{{include "cozystack.platform.package" (list "cozystack.linstor" "default" $ $linstorComponents) }}
{{include "cozystack.platform.package.default" (list "cozystack.linstor-scheduler" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.snapshot-controller" $) }}
{{- end }}

# Cozystack Engine
{{- if .Values.authentication.oidc.enabled }}
{{include "cozystack.platform.package" (list "cozystack.cozystack-engine" "oidc" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.keycloak" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.keycloak-operator" $) }}
{{- else }}
{{include "cozystack.platform.package" (list "cozystack.cozystack-engine" "default" $) }}
{{- end }}

# Common Packages
{{include "cozystack.platform.package.default" (list "cozystack.cert-manager" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.flux-plunger" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.victoria-metrics-operator" $) }}
{{- $tenantComponents := dict -}}
{{- $tenantClusterValues := dict "_cluster" (dict "oidc-enabled" (ternary "true" "false" .Values.authentication.oidc.enabled)) -}}
{{- $_ := set $tenantComponents "tenant" (dict "values" $tenantClusterValues) }}
{{include "cozystack.platform.package" (list "cozystack.tenant-application" "default" $ $tenantComponents) }}
{{include "cozystack.platform.package.default" (list "cozystack.ingress-application" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.seaweedfs-application" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.info-application" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.monitoring-application" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.etcd-application" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.cozystack-basics" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.backupstrategy-controller" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.backup-controller" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.velero" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.vertical-pod-autoscaler" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.metrics-server" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.monitoring-agents" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.goldpinger" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.prometheus-operator-crds" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.grafana-operator" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.etcd-operator" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.postgres-operator" $) }}
{{include "cozystack.platform.package.default" (list "cozystack.objectstorage-controller" $) }}

# Optional System Packages (controlled via bundles.enabledPackages)
{{include "cozystack.platform.package.optional.default" (list "cozystack.nfs-driver" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.telepresence" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.external-dns" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.external-secrets-operator" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.bootbox" $) }}
{{include "cozystack.platform.package.optional.default" (list "cozystack.hetzner-robotlb" $) }}

{{- end }}
