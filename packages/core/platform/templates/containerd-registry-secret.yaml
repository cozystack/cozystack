{{- if .Values.registries.mirrors }}
apiVersion: v1
kind: Secret
metadata:
  name: patch-containerd
  namespace: cozy-system
type: Opaque
stringData:
{{- range $registry, $mirror := .Values.registries.mirrors }}
{{- if $mirror.endpoints }}
  {{ $registry }}.toml: |
    server = "https://{{ $registry }}"
{{- range $endpoint := $mirror.endpoints }}
    [host."{{ $endpoint }}"]
      capabilities = ["pull", "resolve"]
{{- $endpointConfig := index $.Values.registries.config $endpoint }}
{{- if $endpointConfig }}
{{- if $endpointConfig.tls }}
{{- if $endpointConfig.tls.insecureSkipVerify }}
      skip_verify = true
{{- end }}
{{- end }}
{{- if $endpointConfig.auth }}
      [host."{{ $endpoint }}".auth]
        username = "{{ $endpointConfig.auth.username }}"
        password = "{{ $endpointConfig.auth.password }}"
{{- end }}
{{- else }}
      skip_verify = true
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

