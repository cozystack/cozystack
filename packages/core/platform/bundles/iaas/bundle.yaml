{{- $cozyConfig := lookup "v1" "ConfigMap" "cozy-system" "cozystack" }}
{{- $clusterDomain := (index $cozyConfig.data "cluster-domain") | default "cozy.local" }}
{{- $oidcEnabled := index $cozyConfig.data "oidc-enabled" }}
{{- $host := index $cozyConfig.data "root-host" }}
{{- if not $host }}
{{- fail "ERROR need root-host in cozystack ConfigMap" }}
{{- end }}
{{- $apiServerEndpoint := index $cozyConfig.data "api-server-endpoint" }}
{{- if not $apiServerEndpoint }}
{{- fail "ERROR need api-server-endpoint in cozystack ConfigMap" }}
{{- end }}

apiVersion: cozystack.io/v1alpha1
kind: CozystackBundle
metadata:
  name: cozystack-iaas
spec:
  dependsOn: [cozystack-system/network]

  sourceRef:
    kind: {{ .Values.sourceRef.kind }}
    name: {{ .Values.sourceRef.name }}
    namespace: {{ .Values.sourceRef.namespace }}

  libraries:
    - name: cozy-lib
      path: library/cozy-lib

  artifacts:
    - name: bucket
      path: apps/bucket
      libraries: [cozy-lib]
    - name: bucket-system
      path: apps/bucket
      libraries: [cozy-lib]

    - name: kubernetes
      path: apps/kubernetes
      libraries: [cozy-lib]
    - name: kubernetes-ingress-nginx
      path: system/ingress-nginx
    - name: kubernetes-cert-manager-crds
      path: system/cert-manager-crds
    - name: kubernetes-volumesnapshot-crd
      path: system/vsnap-crd
    - name: kubernetes-velero
      path: system/velero
    - name: kubernetes-gateway-api-crds
      path: system/gateway-api-crds
    - name: kubernetes-victoria-metrics-operator
      path: system/victoria-metrics-operator
    - name: kubernetes-kubevirt-csi-node
      path: system/kubevirt-csi-node
    - name: kubernetes-vertical-pod-autoscaler-crds
      path: system/vertical-pod-autoscaler-crds
    - name: kubernetes-coredns
      path: system/coredns
    - name: kubernetes-cert-manager
      path: system/cert-manager
    - name: kubernetes-fluxcd-operator
      path: system/fluxcd-operator
    - name: kubernetes-fluxcd
      path: system/fluxcd
    - name: kubernetes-monitoring-agents
      path: system/monitoring-agents
    - name: kubernetes-cilium
      path: system/cilium
    - name: kubernetes-gpu-operator
      path: system/gpu-operator
    - name: kubernetes-vertical-pod-autoscaler
      path: system/vertical-pod-autoscaler 

    - name: virtual-machine
      path: apps/virtual-machine
      libraries: [cozy-lib]

    - name: vpc
      path: apps/vpc
      libraries: [cozy-lib]

    - name: vm-disk
      path: apps/vm-disk
      libraries: [cozy-lib]

    - name: vm-instance
      path: apps/vm-instance
      libraries: [cozy-lib]

  packages:
  - name: kubevirt-operator
    releaseName: kubevirt-operator
    path: system/kubevirt-operator
    namespace: cozy-kubevirt
    dependsOn: [victoria-metrics-operator]
  
  - name: kubevirt
    releaseName: kubevirt
    path: system/kubevirt
    namespace: cozy-kubevirt
    privileged: true
    dependsOn: [kubevirt-operator]
    {{- $cpuAllocationRatio := index $cozyConfig.data "cpu-allocation-ratio" }}
    {{- if $cpuAllocationRatio }}
    values:
      cpuAllocationRatio: {{ $cpuAllocationRatio }}
    {{- end }}
  
  - name: kubevirt-instancetypes
    releaseName: kubevirt-instancetypes
    path: system/kubevirt-instancetypes
    namespace: cozy-kubevirt
    dependsOn: [kubevirt-operator,kubevirt]
  
  - name: kubevirt-cdi-operator
    releaseName: kubevirt-cdi-operator
    path: system/kubevirt-cdi-operator
    namespace: cozy-kubevirt-cdi
    dependsOn: []
  
  - name: kubevirt-cdi
    releaseName: kubevirt-cdi
    path: system/kubevirt-cdi
    namespace: cozy-kubevirt-cdi
    dependsOn: [kubevirt-cdi-operator]
  
  - name: gpu-operator
    releaseName: gpu-operator
    path: system/gpu-operator
    namespace: cozy-gpu-operator
    privileged: true
    disabled: true
    dependsOn: []
    valuesFiles:
    - values.yaml
    - values-talos.yaml
  
  - name: kamaji
    releaseName: kamaji
    path: system/kamaji
    namespace: cozy-kamaji
    dependsOn: []
  
  - name: capi-operator
    releaseName: capi-operator
    path: system/capi-operator
    namespace: cozy-cluster-api
    privileged: true
    dependsOn: []
  
  - name: capi-providers-bootstrap
    releaseName: capi-providers-bootstrap
    path: system/capi-providers-bootstrap
    namespace: cozy-cluster-api
    privileged: true
    dependsOn: [capi-operator]
  
  - name: capi-providers-core
    releaseName: capi-providers-core
    path: system/capi-providers-core
    namespace: cozy-cluster-api
    privileged: true
    dependsOn: [capi-operator]
  
  - name: capi-providers-cpprovider
    releaseName: capi-providers-cpprovider
    path: system/capi-providers-cpprovider
    namespace: cozy-cluster-api
    privileged: true
    dependsOn: [capi-operator]
  
  - name: capi-providers-infraprovider
    releaseName: capi-providers-infraprovider
    path: system/capi-providers-infraprovider
    namespace: cozy-cluster-api
    privileged: true
    dependsOn: [capi-operator]
