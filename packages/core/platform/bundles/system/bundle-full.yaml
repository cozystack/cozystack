{{- $host := .Values.publishing.host }}
{{- if not $host }}
{{- fail "ERROR: publishing.host is required" }}
{{- end }}
{{- $clusterDomain := .Values.networking.clusterDomain | default "cozy.local" }}
{{- $oidcEnabled := .Values.authentication.oidc.enabled | default false }}
{{- $apiServerEndpoint := .Values.publishing.apiServerEndpoint }}
{{- if not $apiServerEndpoint }}
{{- fail "ERROR: publishing.apiServerEndpoint is required" }}
{{- end }}

apiVersion: cozystack.io/v1alpha1
kind: CozystackBundle
metadata:
  name: cozystack-system
spec:
  deletionPolicy: Orphan

  dependencyTargets:
  - name: network
    packages: [cilium,kubeovn,cert-manager]

  sourceRef:
    kind: {{ .Values.sourceRef.kind }}
    name: {{ .Values.sourceRef.name }}
    namespace: {{ .Values.sourceRef.namespace }}

  libraries:
    - name: cozy-lib
      path: library/cozy-lib

  artifacts:
    - name: tenant
      path: apps/tenant
      libraries: [cozy-lib]
    - name: bootbox
      path: extra/bootbox
      libraries: [cozy-lib]
    - name: etcd
      path: extra/etcd
      libraries: [cozy-lib]
    - name: ingress
      path: extra/ingress
      libraries: [cozy-lib]
    - name: ingress-system
      path: system/ingress-nginx
    - name: seaweedfs
      path: extra/seaweedfs
      libraries: [cozy-lib]
    - name: seaweedfs-system
      path: system/seaweedfs
    - name: info
      path: extra/info
      libraries: [cozy-lib]
    - name: monitoring
      path: extra/monitoring
      libraries: [cozy-lib]

  packages:
    - name: tenant-root
      releaseName: tenant-root
      artifact: tenant
      namespace: tenant-root
      namespaceLabels:
        namespace.cozystack.io/host: {{ $host }}
        namespace.cozystack.io/etcd: tenant-root
        namespace.cozystack.io/ingress: tenant-root
        namespace.cozystack.io/monitoring: tenant-root
        namespace.cozystack.io/seaweedfs: tenant-root
      labels:
        cozystack.io/ui: "true"
        apps.cozystack.io/application.kind: Tenant
        apps.cozystack.io/application.group: apps.cozystack.io
        apps.cozystack.io/application.name: tenant-root
      values:
        host: {{ $host }}

    - name: cilium
      releaseName: cilium
      path: system/cilium
      namespace: cozy-cilium
      privileged: true
      dependsOn: []
      valuesFiles:
      - values.yaml
      - values-talos.yaml
      - values-kubeovn.yaml
    
    - name: cilium-networkpolicy
      releaseName: cilium-networkpolicy
      path: system/cilium-networkpolicy
      namespace: cozy-cilium
      privileged: true
      dependsOn: [cilium]
    
    - name: kubeovn
      releaseName: kubeovn
      path: system/kubeovn
      namespace: cozy-kubeovn
      privileged: true
      dependsOn: [cilium]
      values:
        cozystack:
          nodesHash: {{ include "cozystack.master-node-ips" . | sha256sum }}
        kube-ovn:
          ipv4:
            POD_CIDR: "{{ .Values.networking.podCIDR }}"
            POD_GATEWAY: "{{ .Values.networking.podGateway }}"
            SVC_CIDR: "{{ .Values.networking.serviceCIDR }}"
            JOIN_CIDR: "{{ .Values.networking.joinCIDR }}"
    
    - name: kubeovn-webhook
      releaseName: kubeovn-webhook
      path: system/kubeovn-webhook
      namespace: cozy-kubeovn
      privileged: true
      dependsOn: [cilium,kubeovn,cert-manager]
    
    - name: kubeovn-plunger
      releaseName: kubeovn-plunger
      path: system/kubeovn-plunger
      namespace: cozy-kubeovn
      dependsOn: [cilium,kubeovn,victoria-metrics-operator]
    
    - name: multus
      releaseName: multus
      path: system/multus
      namespace: cozy-multus
      privileged: true
      dependsOn: [cilium,kubeovn]
    
    - name: cozy-proxy
      releaseName: cozystack
      path: system/cozy-proxy
      namespace: cozy-system
      dependsOn: [cilium,kubeovn]
    
    - name: cert-manager-crds
      releaseName: cert-manager-crds
      path: system/cert-manager-crds
      namespace: cozy-cert-manager
      dependsOn: [cilium, kubeovn]
    
    - name: cozystack-api
      releaseName: cozystack-api
      path: system/cozystack-api
      namespace: cozy-system
      dependsOn: [cilium,kubeovn,cozystack-controller]
      values:
        cozystack:
          publishing:
            host: {{ $host }}
            exposedServices: {{ .Values.publishing.exposedServices | default list | toJson }}
            ingressClassName: {{ .Values.publishing.ingressName | default "tenant-root" }}
    
    - name: cozystack-controller
      releaseName: cozystack-controller
      path: system/cozystack-controller
      namespace: cozy-system
      dependsOn: [cilium,kubeovn]
      {{- if not .Values.telemetry.enabled }}
      values:
        cozystackController:
          disableTelemetry: true
      {{- end }}
    
    - name: lineage-controller-webhook
      releaseName: lineage-controller-webhook
      path: system/lineage-controller-webhook
      namespace: cozy-system
      dependsOn: [cozystack-controller,cilium,kubeovn,cert-manager]
    
    - name: cert-manager
      releaseName: cert-manager
      path: system/cert-manager
      namespace: cozy-cert-manager
      dependsOn: [cert-manager-crds]
    
    - name: cert-manager-issuers
      releaseName: cert-manager-issuers
      path: system/cert-manager-issuers
      namespace: cozy-cert-manager
      dependsOn: [cilium,kubeovn,cert-manager]
    
    - name: victoria-metrics-operator
      releaseName: victoria-metrics-operator
      path: system/victoria-metrics-operator
      namespace: cozy-victoria-metrics-operator
      dependsOn: [cilium,kubeovn,cert-manager]
    
    - name: monitoring-agents
      releaseName: monitoring-agents
      path: system/monitoring-agents
      namespace: cozy-monitoring
      privileged: true
      dependsOn: [victoria-metrics-operator, vertical-pod-autoscaler-crds]
      values:
        scrapeRules:
          etcd:
            enabled: true
    
    - name: metallb
      releaseName: metallb
      path: system/metallb
      namespace: cozy-metallb
      privileged: true
      dependsOn: [cilium,kubeovn]
    
    - name: etcd-operator
      releaseName: etcd-operator
      path: system/etcd-operator
      namespace: cozy-etcd-operator
      dependsOn: [cilium,kubeovn,cert-manager]
    
    - name: grafana-operator
      releaseName: grafana-operator
      path: system/grafana-operator
      namespace: cozy-grafana-operator
      dependsOn: [cilium,kubeovn]
    
    - name: postgres-operator
      releaseName: postgres-operator
      path: system/postgres-operator
      namespace: cozy-postgres-operator
      dependsOn: [cilium,kubeovn,cert-manager]
    
    - name: piraeus-operator
      releaseName: piraeus-operator
      path: system/piraeus-operator
      namespace: cozy-linstor
      dependsOn: [cilium,kubeovn,cert-manager,victoria-metrics-operator]
    
    - name: linstor
      releaseName: linstor
      path: system/linstor
      namespace: cozy-linstor
      privileged: true
      dependsOn: [piraeus-operator,cilium,kubeovn,cert-manager,snapshot-controller]
    
    - name: nfs-driver
      releaseName: nfs-driver
      path: system/nfs-driver
      namespace: cozy-nfs-driver
      privileged: true
      dependsOn: [cilium,kubeovn]
      disabled: true
    
    - name: snapshot-controller
      releaseName: snapshot-controller
      path: system/snapshot-controller
      namespace: cozy-snapshot-controller
      dependsOn: [cilium,kubeovn,cert-manager-issuers]
    
    - name: objectstorage-controller
      releaseName: objectstorage-controller
      path: system/objectstorage-controller
      namespace: cozy-objectstorage-controller
      dependsOn: [cilium,kubeovn]
    
    - name: telepresence
      releaseName: traffic-manager
      path: system/telepresence
      namespace: cozy-telepresence
      disabled: true
      dependsOn: [cilium,kubeovn]
    
    - name: dashboard
      releaseName: dashboard
      path: system/dashboard
      namespace: cozy-dashboard
      dependsOn:
      - cilium
      - kubeovn
      - cozystack-api
      - cozystack-controller
      {{- if $oidcEnabled }}
      - keycloak-configure
      {{- end }}
      values:
        cozystack:
          publishing:
            host: {{ $host }}
            ingressClassName: {{ .Values.publishing.ingressName | default "tenant-root" }}
            exposedServices: {{ .Values.publishing.exposedServices | toJson }}
            certificates:
              issuerType: {{ .Values.publishing.certificates.issuerType | default "http01" }}
          authentication:
            oidc:
              enabled: {{ $oidcEnabled }}
              dashboard:
                extraRedirectUris: {{ .Values.authentication.oidc.dashboard.extraRedirectUris | toJson }}
          {{- if hasKey .Values.branding "dashboard" }}
          branding:
            dashboard:
              {{- toYaml .Values.branding.dashboard | nindent 14 }}
          {{- end }}
    
    - name: external-dns
      releaseName: external-dns
      path: system/external-dns
      namespace: cozy-external-dns
      disabled: true
      dependsOn: [cilium,kubeovn]
    
    - name: external-secrets-operator
      releaseName: external-secrets-operator
      path: system/external-secrets-operator
      namespace: cozy-external-secrets-operator
      disabled: true
      dependsOn: [cilium,kubeovn]
    
    - name: bootbox
      releaseName: bootbox
      path: system/bootbox
      namespace: cozy-bootbox
      privileged: true
      disabled: true
      dependsOn: [cilium,kubeovn]
    
    {{- if $oidcEnabled }}
    - name: keycloak
      releaseName: keycloak
      path: system/keycloak
      namespace: cozy-keycloak
      dependsOn: [postgres-operator]
      libraries: [cozy-lib]
      values:
        cozystack:
          publishing:
            host: {{ $host }}
            ingressClassName: {{ .Values.publishing.ingressName | default "tenant-root" }}
            certificates:
              issuerType: {{ .Values.publishing.certificates.issuerType | default "http01" }}
          networking:
            clusterDomain: {{ $clusterDomain }}
          scheduling:
            topologySpreadConstraints: {{ .Values.scheduling.topologySpreadConstraints | default list | toJson }}
    
    - name: keycloak-operator
      releaseName: keycloak-operator
      path: system/keycloak-operator
      namespace: cozy-keycloak
      dependsOn: [keycloak]
    
    - name: keycloak-configure
      releaseName: keycloak-configure
      path: system/keycloak-configure
      namespace: cozy-keycloak
      dependsOn: [keycloak-operator]
      values:
        cozystack:
          publishing:
            host: {{ $host }}
          {{- if hasKey .Values.branding "keycloak" }}
          branding:
            {{- toYaml .Values.branding.keycloak | nindent 12 }}
          {{- end }}

    {{- end }}
    
    - name: goldpinger
      releaseName: goldpinger
      path: system/goldpinger
      namespace: cozy-goldpinger
      privileged: true
      dependsOn: [monitoring-agents]
    
    - name: vertical-pod-autoscaler
      releaseName: vertical-pod-autoscaler
      path: system/vertical-pod-autoscaler
      namespace: cozy-vertical-pod-autoscaler
      privileged: true
      dependsOn: [monitoring-agents]
      values:
        vertical-pod-autoscaler:
          recommender:
            extraArgs:
              prometheus-address: http://vmselect-shortterm.tenant-root.svc.{{ $clusterDomain }}:8481/select/0/prometheus/
    
    - name: vertical-pod-autoscaler-crds
      releaseName: vertical-pod-autoscaler-crds
      path: system/vertical-pod-autoscaler-crds
      namespace: cozy-vertical-pod-autoscaler
      privileged: true
      dependsOn: [cilium, kubeovn]
    
    - name: reloader
      releaseName: reloader
      path: system/reloader
      namespace: cozy-reloader
    
    - name: velero
      releaseName: velero
      path: system/velero
      namespace: cozy-velero
      privileged: true
      disabled: true
      dependsOn: [monitoring-agents]
    
    - name: hetzner-robotlb
      releaseName: robotlb
      disabled: true
      path: system/hetzner-robotlb
      namespace: cozy-hetzner-robotlb
      dependsOn: [cilium, kubeovn]
