{{- $cozyConfig := lookup "v1" "ConfigMap" "cozy-system" "cozystack" }}
{{- $clusterDomain := (index $cozyConfig.data "cluster-domain") | default "cozy.local" }}
{{- $oidcEnabled := index $cozyConfig.data "oidc-enabled" }}
{{- $host := index $cozyConfig.data "root-host" }}
{{- if not $host }}
{{- fail "ERROR need root-host in cozystack ConfigMap" }}
{{- end }}
{{- $apiServerEndpoint := index $cozyConfig.data "api-server-endpoint" }}
{{- if not $apiServerEndpoint }}
{{- fail "ERROR need api-server-endpoint in cozystack ConfigMap" }}
{{- end }}

apiVersion: cozystack.io/v1alpha1
kind: CozystackBundle
metadata:
  name: cozystack-system
  finalizers:
    - cozystack.io/system-bundle-protection
spec:

  dependencyTargets:
  - name: network
    packages: []

  sourceRef:
    kind: {{ .Values.sourceRef.kind }}
    name: {{ .Values.sourceRef.name }}
    namespace: {{ .Values.sourceRef.namespace }}

  libraries:
    - name: cozy-lib
      path: packages/library/cozy-lib

  packages:
  - name: fluxcd-operator
    releaseName: fluxcd-operator
    path: packages/system/fluxcd-operator
    namespace: cozy-fluxcd
    privileged: true
    dependsOn: []
  
  - name: fluxcd
    releaseName: fluxcd
    path: packages/system/fluxcd
    namespace: cozy-fluxcd
    dependsOn: [fluxcd-operator]
    values:
      flux-instance:
        instance:
          cluster:
            domain: {{ $clusterDomain }}
  
  - name: cert-manager-crds
    releaseName: cert-manager-crds
    path: packages/system/cert-manager-crds
    namespace: cozy-cert-manager
    dependsOn: []
  
  - name: cozystack-api
    releaseName: cozystack-api
    path: packages/system/cozystack-api
    namespace: cozy-system
    dependsOn: [cozystack-controller]
    values:
      cozystackAPI:
        localK8sAPIEndpoint:
          enabled: false
  
  - name: cozystack-controller
    releaseName: cozystack-controller
    path: packages/system/cozystack-controller
    namespace: cozy-system
    dependsOn: []
    {{- if eq (index $cozyConfig.data "telemetry-enabled") "false" }}
    values:
      cozystackController:
        disableTelemetry: true
    {{- end }}
  
  - name: lineage-controller-webhook
    releaseName: lineage-controller-webhook
    path: packages/system/lineage-controller-webhook
    namespace: cozy-system
    dependsOn: [cozystack-controller,cert-manager]
  
  - name: cozystack-resource-definition-crd
    releaseName: cozystack-resource-definition-crd
    path: packages/system/cozystack-resource-definition-crd
    namespace: cozy-system
    dependsOn: [cozystack-api,cozystack-controller]
  
  - name: cozystack-resource-definitions
    releaseName: cozystack-resource-definitions
    path: packages/system/cozystack-resource-definitions
    namespace: cozy-system
    dependsOn: [cozystack-api,cozystack-controller,cozystack-resource-definition-crd]
  
  - name: cert-manager
    releaseName: cert-manager
    path: packages/system/cert-manager
    namespace: cozy-cert-manager
    dependsOn: [cert-manager-crds]
  
  - name: cert-manager-issuers
    releaseName: cert-manager-issuers
    path: packages/system/cert-manager-issuers
    namespace: cozy-cert-manager
    dependsOn: [cert-manager]
  
  - name: victoria-metrics-operator
    releaseName: victoria-metrics-operator
    path: packages/system/victoria-metrics-operator
    namespace: cozy-victoria-metrics-operator
    dependsOn: [cert-manager]
  
  - name: monitoring-agents
    releaseName: monitoring-agents
    path: packages/system/monitoring-agents
    namespace: cozy-monitoring
    privileged: true
    dependsOn: [victoria-metrics-operator, vertical-pod-autoscaler-crds]
    values:
      scrapeRules:
        etcd:
          enabled: true
  
  - name: etcd-operator
    releaseName: etcd-operator
    path: packages/system/etcd-operator
    namespace: cozy-etcd-operator
    dependsOn: [cert-manager]
  
  - name: grafana-operator
    releaseName: grafana-operator
    path: packages/system/grafana-operator
    namespace: cozy-grafana-operator
    dependsOn: []
  
  - name: mariadb-operator
    releaseName: mariadb-operator
    path: packages/system/mariadb-operator
    namespace: cozy-mariadb-operator
    dependsOn: [cert-manager,victoria-metrics-operator]
    values:
      mariadb-operator:
        clusterName: {{ $clusterDomain }}
  
  - name: postgres-operator
    releaseName: postgres-operator
    path: packages/system/postgres-operator
    namespace: cozy-postgres-operator
    dependsOn: [cert-manager,victoria-metrics-operator]
  
  - name: objectstorage-controller
    releaseName: objectstorage-controller
    path: packages/system/objectstorage-controller
    namespace: cozy-objectstorage-controller
    dependsOn: []
  
  - name: telepresence
    releaseName: traffic-manager
    path: packages/system/telepresence
    namespace: cozy-telepresence
    disabled: true
    dependsOn: []
  
  - name: external-dns
    releaseName: external-dns
    path: packages/system/external-dns
    namespace: cozy-external-dns
    disabled: true
    dependsOn: []
  
  - name: external-secrets-operator
    releaseName: external-secrets-operator
    path: packages/system/external-secrets-operator
    namespace: cozy-external-secrets-operator
    disabled: true
    dependsOn: []
  
  - name: dashboard
    releaseName: dashboard
    path: packages/system/dashboard
    namespace: cozy-dashboard
    {{- if eq $oidcEnabled "true" }}
    dependsOn: [keycloak-configure,cozystack-api]
    {{- else }}
    dependsOn: []
    {{- end }}
  
  {{- if $oidcEnabled }}
  - name: keycloak
    releaseName: keycloak
    path: packages/system/keycloak
    namespace: cozy-keycloak
    dependsOn: [postgres-operator]
    libraries: [cozy-lib]
  
  - name: keycloak-operator
    releaseName: keycloak-operator
    path: packages/system/keycloak-operator
    namespace: cozy-keycloak
    dependsOn: [keycloak]
  
  - name: keycloak-configure
    releaseName: keycloak-configure
    path: packages/system/keycloak-configure
    namespace: cozy-keycloak
    dependsOn: [keycloak-operator]
    values:
      cozystack:
        configHash: {{ $cozyConfig | toJson | sha256sum }}
  {{- end }}
  
  - name: goldpinger
    releaseName: goldpinger
    path: packages/system/goldpinger
    namespace: cozy-goldpinger
    privileged: true
    dependsOn: [monitoring-agents]
  
  - name: vertical-pod-autoscaler
    releaseName: vertical-pod-autoscaler
    path: packages/system/vertical-pod-autoscaler
    namespace: cozy-vertical-pod-autoscaler
    privileged: true
    dependsOn: [monitoring-agents]
    values:
      vertical-pod-autoscaler:
        recommender:
          extraArgs:
            prometheus-address: http://vmselect-shortterm.tenant-root.svc.{{ $clusterDomain }}:8481/select/0/prometheus/
  
  - name: vertical-pod-autoscaler-crds
    releaseName: vertical-pod-autoscaler-crds
    path: packages/system/vertical-pod-autoscaler-crds
    namespace: cozy-vertical-pod-autoscaler
    privileged: true
    dependsOn: []
  
  - name: velero
    releaseName: velero
    path: packages/system/velero
    namespace: cozy-velero
    privileged: true
    disabled: true
    dependsOn: [monitoring-agents]
  
  - name: hetzner-robotlb
    releaseName: robotlb
    disabled: true
    path: packages/system/hetzner-robotlb
    namespace: cozy-hetzner-robotlb
